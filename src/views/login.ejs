<html>
<head>
    <meta http-equiv="content-language" content="tr">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
</head>
<body>
<h1> Oturum Aç</h1>

<form action="/login" method="post" >
    <div id="loginError" class="loginError"><%if(locals.alert)%><%=locals.message%></div>
    <input id="email" name="email" type= "text" placeholder= "E-posta veya telefon numarası" onfocusout="emailFocusOut()">
    <div id="emailError" class="inputError" hidden></div>
    <input id="pass" name="pass" type= "password" placeholder="Parola" onfocusout="passFocusOut()">
<!--    Show hide password button-->
    <div id="passError" class="inputError" hidden ></div>
    <button type="submit">Oturum Aç</button>
<!--    Check inputs before submitting-->
</form>
<a href="/signup">Şimdi kaydolun</a>
<a href="/forgotpassword">Şifremi unuttum</a>

<script type="text/javascript">
    function containsLetter(inputtxt)
    {
        var letters = /[^\d.+()]+/;
        if (inputtxt.match(letters)) return true;
        return false;
    }

    function emailFocusOut()
    {
        if (checkEmailError()) document.getElementById("emailError").hidden = false;
    }

    function checkEmailError()
    {
        if (document.getElementById("email").value.length == 0)
        {
            document.getElementById("emailError").innerText = "Lütfen geçerli bir telefon numarası veya e‑posta adresi girin.";
            return true;
        }
        else if (document.getElementById("email").value.length < 5 || document.getElementById("email").value.length > 50)
        {
            if (containsLetter(document.getElementById("email").value)) document.getElementById("emailError").innerText = "Lütfen geçerli bir e‑posta adresi girin.";
            else document.getElementById("emailError").innerText = "Lütfen geçerli bir telefon numarası girin.";
            return true;
        }
        else
        {
            document.getElementById("emailError").innerText = "";
            return false;
        }
    }

    function passFocusOut()
    {
        if (checkPassError()) document.getElementById("passError").hidden = false;
    }

    function checkPassError()
    {
        if (document.getElementById("pass").value.length < 4 || document.getElementById("pass").value.length > 60)
        {
            document.getElementById("passError").innerText = "Parolanız 4 ila 60 karakter olmalıdır.";
            return true;
        }
        else
        {
            document.getElementById("passError").innerText = "";
            return false;
        }
    }

    document.getElementById("email").oninput = checkEmailError;
    document.getElementById("pass").oninput = checkPassError;

    document.getElementById("loginBtn").onclick = function () {
        //Show errors after pressing button even if the focus is not lost
        document.getElementById("emailError").hidden = false;
        document.getElementById("passError").hidden = false;
        if(checkEmailError() || checkPassError()) return;

        console.log("button clicked");

        email = document.getElementById("email").value;
        password = document.getElementById("pass").value;
        console.log(email);
        console.log(password);

        $.getJSON("users.json", checkUserData).fail(function(){
            console.log("An error has occurred reading json file.");
        });

    };
    function checkUserData(users){
        var emailFound = false;
        for(i = 0; i < users.length; i++){
            console.log(users[i]);
            if(users[i].Email  == email){
                console.log("match!" + email);
                emailFound = true;
                if( users[i].Password == password ){
                    alert("Login Successful, Welcome " + users[i].Name);
                    location.href="/";
                    return;
                }
                document.getElementById("emailError").hidden = false;
                document.getElementById("emailError").innerHTML = "Parola yanlış. Lütfen yeniden deneyin ya da <a href='/forgotpassword'>parolanızı sıfırlayın</a>.";
                break;
            }
        }

        if(!emailFound){
            document.getElementById("emailError").hidden = false;
            document.getElementById("emailError").innerHTML = "Bu e‑posta adresi ile bağlantılı bir hesap bulamadık. Lütfen yeniden deneyin ya da <a href='/signup'>yeni bir hesap oluşturun</a>.";
        }
    }
</script>
</body>


</html>